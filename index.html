<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Condition Report CSV Generator</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
:root {
  --bg:#f5f7fa;
  --card:#fff;
  --primary:#4f46e5;
  --danger:#ef4444;
  --success:#10b981;
  --border:#e5e7eb;
  --radius:14px;
}
body {
  margin:0;
  padding:40px;
  background:var(--bg);
  font-family:Inter,Arial,sans-serif;
}
.container {
  max-width:900px;
  margin:auto;
  background:var(--card);
  padding:28px;
  border-radius:var(--radius);
  box-shadow:0 10px 30px rgba(0,0,0,.08);
}
h1 { margin-top:0; }
label { font-weight:600; display:block; margin-top:16px; }
input, textarea {
  width:100%;
  padding:12px;
  border-radius:10px;
  border:1px solid var(--border);
  margin-top:6px;
}
textarea {
  height:240px;
  font-family:monospace;
}
.actions {
  display:flex;
  gap:12px;
  margin-top:20px;
}
button {
  padding:12px 18px;
  border:none;
  border-radius:12px;
  font-weight:600;
  cursor:pointer;
}
.generate { background:var(--primary); color:white; }
.copy { background:var(--success); color:white; }
.clear { background:var(--danger); color:white; }
.footer-note {
  margin-top:12px;
  font-size:13px;
  color:#64748b;
}
</style>
</head>

<body>
<div class="container">
  <h1>Condition Report Test Data Generator</h1>

  <label>Weeks Back</label>
  <input type="number" id="weeksBack" value="6" min="1" max="52" />

  <label>Paste CSV Input</label>
  <textarea id="csvInput" placeholder="
DealershipId,Monday,Tuesday,Wednesday,Thursday,Friday,Saturday,Sunday
abcd,6,0,0,0,0,0,0
xyz,2,1,0,0,0,0,0
"></textarea>

  <div class="actions">
    <button class="generate" onclick="generate()">Generate</button>
    <button class="copy" onclick="copy()">Copy CSV</button>
    <button class="clear" onclick="clearAll()">Clear</button>
  </div>

  <label>Generated CSV</label>
  <textarea id="output" readonly></textarea>

  <div class="footer-note">
    Records generated = weekday average Ã— weeks back.  
    Dates are deterministic and Salesforce-ready.
  </div>
</div>

<script>
/* ==========================
   CONSTANTS
========================== */
const WEEKDAYS = [
  'Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'
];

/* ==========================
   CORE FUNCTIONS
========================== */

function parseCSV(text) {
  const lines = text.trim().split('\n');
  const headers = lines.shift().split(',').map(h => h.trim());
  return lines.map(line => {
    const values = line.split(',').map(v => v.trim());
    return headers.reduce((obj, h, i) => {
      obj[h] = values[i] || '';
      return obj;
    }, {});
  });
}

/**
 * Returns the past N calendar dates matching weekdayName (UTC based)
 */
function getPastWeekdayDates(weekdayName, weeks) {
  const targetDay = WEEKDAYS.indexOf(weekdayName);
  const today = new Date();
  
  // Anchor at UTC midnight
  const todayUTC = new Date(Date.UTC(
    today.getUTCFullYear(),
    today.getUTCMonth(),
    today.getUTCDate()
  ));

  const result = [];

  for (let w = 0; w < weeks; w++) {
    const d = new Date(todayUTC);
    const diff = (d.getUTCDay() - targetDay + 7) % 7;
    d.setUTCDate(d.getUTCDate() - diff - (7 * w));

    result.push(d);
  }
  return result;
}

/**
 * Format with fixed timestamp and no timezone drift
 * Salesforce-friendly
 */
function formatSFDate(date) {
  const yyyy = date.getUTCFullYear();
  const mm = String(date.getUTCMonth()+1).padStart(2,'0');
  const dd = String(date.getUTCDate()).padStart(2,'0');

  return `${yyyy}-${mm}-${dd}T09:50:12.000+0000`;
}

/* ==========================
   GENERATOR
========================== */

function generate() {
  const weeks = parseInt(document.getElementById('weeksBack').value || '6', 10);
  const csvText = document.getElementById('csvInput').value.trim();
  if (!csvText) return alert('Paste CSV data first');

  const data = parseCSV(csvText);
  let out = ['Dealership__c\tCreatedDate'];

  data.forEach(row => {
    const dealerId = row.DealershipId;
    if (!dealerId) return;

    WEEKDAYS.forEach(day => {
      const avg = parseInt(row[day] || '0', 10);
      if (avg <= 0) return;

      const dates = getPastWeekdayDates(day, weeks);
      dates.forEach(d => {
        for (let i = 0; i < avg; i++) {
          out.push(`${dealerId}\t${formatSFDate(d)}`);
        }
      });
    });
  });

  document.getElementById('output').value = out.join('\n');
}

/* ==========================
   UTILITIES
========================== */

function copy() {
  const txt = document.getElementById('output').value;
  if (!txt) return alert('Nothing to copy');
  navigator.clipboard.writeText(txt).then(() => alert('Copied'));
}

function clearAll() {
  document.getElementById('csvInput').value = '';
  document.getElementById('output').value = '';
}
</script>
</body>
</html>
